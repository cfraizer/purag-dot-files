#!/bin/bash

function trace_exec () {
  echo "====== $@" | tee log/install
  "$@" 2>&1 | tee log/install
  echo "====== END $@" | tee log/install
}

mkdir -p log

case "$(uname)" in
"Darwin")
  echo "== Installing OSX config..."

  if ! which brew &> /dev/null; then
    echo "==== Installing homebrew..."
    trace_exec /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/installi)"
    echo "==== Done."
  fi

  if ! which stow &> /dev/null; then
    echo "==== Installing stow..."
    trace_exec brew install gnu-stow
    echo "==== Done."
  fi
;;

"Linux")
    # https://github.com/dylanaraps/neofetch/blob/master/neofetch
    distro="$(awk -F 'NAME=' '/^NAME=/ {printf $2}' /etc/*ease)"
    distro="${distro//\"}"

    case "$distro" in
    "Ubuntu")
      if ! which stow &> /dev/null; then
        echo "==== Installing stow..."
        trace_exec sudo apt-get install stow
        echo "==== Done."
      fi

      if ! which ctags &> /dev/null; then
        echo "==== Installing ctags..."
        trace_exec sudo apt-get install exuberant-ctags
        echo "==== Done."
      fi
    ;;

    *)
      echo "== No config installation provided for [$distro]."
      exit 1
    esac
esac

echo "==== Stowing ~/.files/meat..."
trace_exec stow meat
echo "==== Done."

echo "==== Cloning purag/scripts to ~/scripts..."
trace_exec git clone https://github.com/purag/scripts.git ~/scripts
echo "==== Done."

if [ ! -f "~/.vim/autoload/plug.vim" ]; then
  echo "==== Downloading vim-plug..."
  trace_exec curl -fLo ~/.vim/autoload/plug.vim --create-dirs \
    https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
  echo "==== Done."
fi

echo "==== Installing vim plugins..."
vim +PlugInstall +qall
echo "==== Done."

echo "== Done."
echo "== View logs in $(pwd)/log/install."
